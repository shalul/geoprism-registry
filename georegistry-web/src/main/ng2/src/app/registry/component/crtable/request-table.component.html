<div class="row">
  <div class="col-md-12">
    <div class="form-group button-row">

      <a [routerLink]="" (click)="filter('ALL')" [ngClass]="filterCriteria === 'ALL' ? 'cr-filter-link-active' : ''" >
        <localize key="change.request.all.filter.link"></localize>
      </a>
      <a [routerLink]="" (click)="filter('PENDING')" [ngClass]="filterCriteria === 'PENDING' ? 'cr-filter-link-active' : ''" style="margin-left: 5px;">
        <localize key="change.request.pending.filter.link"></localize>
      </a>
      <a [routerLink]="" (click)="filter('ACCEPTED')" [ngClass]="filterCriteria === 'ACCEPTED' ? 'cr-filter-link-active' : ''" style="margin-left: 5px;">
        <localize key="change.request.accepted.filter.link"></localize>
      </a>
<!-- 
      <a [routerLink]="" (click)="filter('REJECTED')" [ngClass]="filterCriteria === 'REJECTED' ? 'cr-filter-link-active' : ''"style="margin-left: 5px;" >
        <localize key="change.request.rejected.filter.link"></localize>
      </a>
 -->      

    </div>

    <hr style="border-top:solid 3px #6BA542" />

  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <table class="table">
      <thead>
        <tr style="height: 50px;color: grey;">
          <th style="vertical-align: middle;"> <localize key="change.request.contributor.label"></localize> </th>
          <th style="vertical-align: middle;"> <localize key="change.request.id.label"></localize> </th>
          <th style="vertical-align: middle;"> <localize key="change.request.date.contributed.label"></localize> </th>
          <th style="vertical-align: middle;"> <localize key="change.request.status.label"></localize> </th>
          <!-- <th style="vertical-align: middle;">Actions</th> -->
          <th></th>
        </tr>
      </thead>
      <tbody>
        <ng-template ngFor let-req [ngForOf]="requests | paginate: { itemsPerPage: page.pageSize, currentPage: page.pageNumber, totalItems: page.count }" [ngForTrackBy]="requestTrackBy">
        
          <tr class="clickable" [ngClass]="{'row-active':toggleId === req.oid}" (click)="toggle($event, req.oid)" style="height: 50px;">
            <td class="col-md-3">
              <h5><strong>{{req.createdBy}}</strong></h5>
            </td>
            <td class="col-md-4">
              <h5><strong>{{req.oid}}</strong></h5>
            </td>
            <td class="col-md-2" style="vertical-align: middle; color:grey;">
               <span class="date-string-display">
                  {{formatDate(req.createDate)}}
               </span>
            </td>
            <td class="col-md-2">
              <h5 [ngClass]="{'status-pending':req.approvalStatus === 'PENDING', 'status-accepted':req.approvalStatus === 'ACCEPTED', 'status-rejected':req.approvalStatus === 'REJECTED'}">
                 <strong>{{req.statusLabel}}</strong>
              </h5>
            </td>
            <td class="col-md-1" style="vertical-align:middle;text-align:right;padding-right:25px;">
              <i class="arrow arrow-right" aria-hidden="true"></i>
            </td>
          </tr>
          
          <!-- Action panel only shows when activated with click -->
          <tr [@fadeInOut] *ngIf="toggleId === req.oid" style="background-color:#f7f7f7;" [ngClass]="{'status-pending-container':req.approvalStatus === 'PENDING', 'status-accepted-container':req.approvalStatus === 'ACCEPTED', 'status-rejected-container':req.approvalStatus === 'REJECTED'}">
            
            <td colspan="5">
              <div class="geoobject-panel-header">
              
                    <div>
                        <h3 style="margin-top: 10px;">{{req.geoObject.label}}</h3>
                        <h4>{{req.geoObject.code}}</h4>
                    </div>
              </div>
                  
              <div class="row" style="margin:0;background: white;">
                <!-- <div class="col-md-1"></div> -->
                <div class="col-md-12">
                
                  <div *ngIf="req.permissions.includes('READ_CONTRIBUTOR_NOTES')" class="form-group" style="margin-top:20px;">
                     <label for="contribNotesInput-{{req.oid}}"> <localize key="change.request.contributor.notes.label"></localize> </label>
                     <textarea id="contribNotesInput-{{req.oid}}" class="form-control" style="height:90px;max-width:100%;" [(ngModel)]="req.contributorNotes" disabled></textarea>
                  </div>  
                  
                  <div>
                    <p><localize key="change.request.contributor.prefix.label"></localize>&nbsp;<strong>{{req.createdBy}}</strong></p>
                    <p><localize key="change.request.contributor.email.prefix.label"></localize>&nbsp;<strong>{{req.email}}</strong></p>
                    <p><localize key="change.request.contributor.phone.prefix.label"></localize>&nbsp;<strong>{{req.phoneNumber}}</strong></p>
                  </div>
  
                  <div class="action-card" style="margin-bottom:10px; background-color:white;"> 
                    <div class="row" style="background: white;">
                      <div class="col-md-12">
                      
                         <geoobject-shared-attribute-editor *ngIf="req"
                              #attributeEditor
                              [readOnly]="!req.permissions.includes('WRITE_DETAILS')"  
                              [geoObjectType]="req.current.geoObjectType"
                              [geoObjectData]="{'geoObject': req.type == 'UpdateGeoObject' ? req.current.geoObject : req.actions[0].geoObjectJson, 'actions': req.actions}"
                              [changeRequest]="req"
                              [forDate]="today"
                              [hierarchies]="req.type == 'UpdateGeoObject' ? req.current.hierarchies : req.actions[0].parentJson"
                              [isGeometryInlined]="true">
                         </geoobject-shared-attribute-editor>
                         
                       </div>
                    </div>
  
                    <div class="row" style="border-top: 1px grey solid;margin:0;padding: 10px 0;">
                      <div class="col-md-6" >
                        <div *ngIf="req.permissions.includes('READ_MAINTAINER_NOTES')" class="form-group">
                          <label for="maintainerNotesInput-{{req.oid}}"> <localize key="change.request.maintainer.notes.label"></localize> </label>
                          <textarea id="maintainerNotesInput-{{req.oid}}" class="form-control" style="height:90px;max-width:100%;margin:0" [(ngModel)]="req.maintainerNotes" [disabled]="!req.permissions.includes('WRITE_MAINTAINER_NOTES')"></textarea>
                        </div>  
                        
                        <div *ngIf="req.permissions.includes('READ_MAINTAINER_NOTES')" class="form-group">
                              <label for="additionalNotes-{{req.oid}}"> <localize key="change.request.action.detail.additionalNotes"></localize> </label>
                              <input type="text" id="additionalNotes-{{req.oid}}" class="form-control" style="width:100%;" [(ngModel)]="req.additionalNotes" [disabled]="!req.permissions.includes('WRITE_MAINTAINER_NOTES')">
                        </div>  
                      </div>
                      
                      <div class="col-md-6" >
                        <div>
                          <label><localize key="change.request.reference.documents.label"></localize></label>
                          <div *ngIf="req.documents.length > 0" style="border:1px solid #ccc;border-radius: 4px;">
                            <ul style="padding:10px;margin:0;">
                                <li *ngFor="let doc of req.documents" class="list-group-item" style="padding:0;font-size:inherit;">
                                  <a (click)="onDownloadFile(req, doc.oid)" >{{doc.fileName}}</a>
                                  <i (click)="onDeleteFile(req, doc.oid)" class="fa fa-times ico-remove" style="margin-left:10px;" aria-hidden="true"></i>
                                </li>
                            </ul>
                          </div>
                          <p *ngIf="req.documents.length === 0" style="color:grey;font-style:italic;">
                            <localize key="change.request.no.documents.label"></localize>
                          </p>
                        
                          <div *ngIf="req.permissions.includes('WRITE_DOCUMENTS')" style="padding:10px 0;">
                              <!-- Limit file types with: accept=".xls, .xlsx, .pdf, .doc" -->
                              <input class="ghost-input" style="display:inline-block;padding:0;height:auto;border-radius:0;margin-top:10px;" #myFile name="file" type="file" ng2FileSelect [uploader]="uploader" required />
                              
                              <button class="btn btn-primary pull-right" style="margin:0;" (click)="onUpload(req)" [title]="'change.request.upload.document.btn.hover' | localize">
                                <localize key="change.request.reference.document.upload"></localize>
                              </button>
                          </div>
                        </div>
  
                      </div>
                    </div>
                  </div> 
  
  
                  <div *ngIf="req.permissions.includes('WRITE_APPROVAL_STATUS') || req.permissions.includes('DELETE')" class="button-holder" style="margin-bottom:20px;">
                    <span *ngIf="req.permissions.includes('WRITE_APPROVAL_STATUS')">
                      <button [disabled]="req.approvalStatus !== 'PENDING'" type="submit" (click)="onExecute(req)" class="btn btn-primary" style="margin:0;" role="button" [title]="'change.request.implement.decisions.btn.hover' | localize">
                        <localize key="change.request.accept.changes.btn"></localize>
                      </button>
                    </span>
                    
                    <button type="submit" role="button" class="btn btn-danger pull-right" [disabled]="!req.permissions.includes('DELETE')" (click)="req.createdBy === getUsername() && onDelete(req)" [title]="'change.request.delete.request.hover' | localize" >
                      <localize key="change.request.delete.request.btn"></localize>
                    </button>
                    
                  </div>
                </div>
                <!-- <div class="col-md-1"></div> -->
              </div>
  
            </td>
          </tr> <!-- END Action panel -->
          
        </ng-template>
      </tbody>
    </table>
    <div class="solid-table-footer">
	    <div *ngIf="page.resultSet.length > 0" class="solid-table-footer">
        <pagination-controls (pageChange)="refresh($event)"></pagination-controls>
	    </div>
    </div>
  </div>   
</div>
