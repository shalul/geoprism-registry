<ng-template #customItemTemplate let-model="item" let-index="index">
    <h5>{{model.name }} : {{ model.code }}</h5>
</ng-template>

<div class="modal-body row">
    <div *ngIf="message != null" class="alert alert-danger" role="alert">{{message}}</div>

    <form #form="ngForm" class="modal-form col-md-8" autocomplete="off">

        <fieldset *ngIf="event != null">
            <div class="row-holder">
                <div class="label-holder">
                    <label>
                        <localize key="transition.event.date"></localize>
                    </label>
                </div>
                <div class="holder">
                    <span *ngIf="readonly" style="line-height: 40px;" class="date-string-display">
                        {{formatDate(event.eventDate)}}
                    </span>
                    <date-field *ngIf="!readonly" [(value)]="event.eventDate" [classNames]="['form-control']" label=""
                        [inputName]="'eventDate'" [allowFutureDates]="false" name="eventDate" [required]="true"
                        [disable]="readonly || event.transitions.length > 0"></date-field>
                </div>
            </div>
        
            <div class="row-holder" *ngFor="let localeValue of event.description.localeValues">
                <div class="label-holder">
                    <label> <localize key="transition.event.description"></localize>
                        <span style="color: #BABABA">&nbsp;(<convert-key-label [key]="localeValue.locale">
                            </convert-key-label>)</span>
                    </label>
                </div>
                <div class="holder">
                    <input [(ngModel)]="localeValue.value" [name]="'label-' + localeValue.locale" type="text"
                        class="form-control" [disabled]="readonly"
                        [required]="localeValue.locale === 'defaultLocale'" />
                </div>
            </div>

            <div class="row-holder">
                <div class="label-holder">
                    <label for="beforeTypeCode">
                        <localize key="transition.event.beforeType"></localize>
                    </label>
                </div>
                <div *ngIf="!readonly && types != null" class="holder">
                    <select id="beforeTypeCode" name="beforeTypeCode" class="select-area" [(ngModel)]="event.beforeTypeCode"
                        (change)="onChange()" [disabled]="event.transitions.length > 0" required>
                        <option></option>
                        <option *ngFor="let type of types" [value]="type.code">{{type.label}}</option>
                    </select>
                </div>
                <div *ngIf="readonly" class="holder">
                    <input [(ngModel)]="event.beforeTypeLabel" name="typeCode" type="text" class="form-control"
                        disabled />
                </div>
            </div>
            
            <div class="row-holder">
                <div class="label-holder">
                    <label for="afterTypeCode">
                        <localize key="transition.event.afterType"></localize>
                    </label>
                </div>
                <div *ngIf="!readonly && types != null" class="holder">
                    <select id="afterTypeCode" name="afterTypeCode" class="select-area" [(ngModel)]="event.afterTypeCode"
                        (change)="onChange()" [disabled]="event.transitions.length > 0" required>
                        <option></option>
                        <option *ngFor="let type of types" [value]="type.code">{{type.label}}</option>
                    </select>
                </div>
                <div *ngIf="readonly" class="holder">
                    <input [(ngModel)]="event.afterTypeLabel" name="typeCode" type="text" class="form-control"&&
                        disabled />
                </div>
            </div>

            <div class="row-holder" *ngIf="event.beforeTypeCode != null && event.beforeTypeCode !== '' && event.afterTypeCode != null && event.afterTypeCode !== '' && event.eventDate != null && event.eventDate !== ''">
                    <table class="table">
                        <thead>
                            <tr style="height: 50px;color: grey;">
                                <th style="width: 35%; vertical-align: middle;"> <localize key="transition.event.before"></localize> </th>
                                <th style="width: 12%; vertical-align: middle;"> </th>
                                <th style="width: 35%; vertical-align: middle;"> <localize key="transition.event.after"></localize> </th>
                                <th style="width: 14%; vertical-align: middle;"> <localize key="transition.event.type"></localize> </th>
                                <th style="width: 4%; vertical-align: middle;"></th>
                                <th style="width: 4%; vertical-align: middle;" *ngIf="!readonly"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let transition of event.transitions; let i = index;" style="height: 50px;">
                                <td>
                                    <div class="input-group">
                                        <input type="text" class="form-control" autocomplete="off"
                                            [name]="'transition.source-' + i" [disabled]="readonly" required
                                            [(ngModel)]="transition.sourceText" [typeaheadAsync]="true"
                                            [typeahead]="getTypeAheadObservable(transition, this.event.beforeTypeCode, 'sourceText')"
                                            (typeaheadOnSelect)="typeaheadOnSelect($event, transition, 'sourceText')"
                                            [typeaheadOptionsLimit]="7" [typeaheadItemTemplate]="customItemTemplate"
                                            [typeaheadMinLength]="0" [typeaheadWaitMs]="300" [container]="'#typeaheadParentS-' + i">

                                        <div style="position: absolute;">
                                            <div [id]="'typeaheadParentS-' + i" style="position: fixed; z-index: 10;">
                                            </div>
                                        </div>

                                        <span *ngIf="!readonly" class="input-group-addon clickable addon-alert"
                                            (click)="clear(transition, 'sourceText')">
                                            <i class="fa fa-times" aria-hidden="true"></i>
                                        </span>

                                        <!-- Hack: This is needed for formatting  -->
                                        <span *ngIf="readonly" class="input-group-addon addon-alert">
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <input type="text" [name]="'transition.impact-' + i" class="form-control" [ngModel]="localizeTransitionImpact(transition.impact)" disabled required>
                                </td>
                                <td>
                                    <div  class="input-group">
                                        <input type="text" class="form-control" autocomplete="off"
                                            [name]="'transition.target-' + i" [disabled]="readonly" required
                                            [(ngModel)]="transition.targetText" [typeaheadAsync]="true"
                                            [typeahead]="getTypeAheadObservable(transition, this.event.afterTypeCode, 'targetText')"
                                            (typeaheadOnSelect)="typeaheadOnSelect($event, transition, 'targetText')"
                                            [typeaheadOptionsLimit]="7" [typeaheadItemTemplate]="customItemTemplate"
                                            [typeaheadMinLength]="0" [typeaheadWaitMs]="300" [container]="'#typeaheadParentT-' + i">
                                        
                                        <div style="position: absolute;">
                                            <div [id]="'typeaheadParentT-' + i" style="position: fixed; z-index: 10;">
                                            </div>
                                        </div>

                                        <span *ngIf="!readonly" class="input-group-addon clickable addon-alert"
                                            (click)="clear(transition, 'targetText')">
                                            <i class="fa fa-times" aria-hidden="true"></i>
                                        </span>

                                        <!-- Hack: This is needed for formatting  -->
                                        <span *ngIf="readonly" class="input-group-addon addon-alert">
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <input *ngIf="!transition.typeUpdown" type="text" [name]="'transition.transitionType-' + i" class="form-control" [ngModel]="localizeTransitionType(transition.transitionType)" disabled required>
                                    <select *ngIf="transition.typeUpdown" [name]="'transition.transitionType-updown-' + i" class="select-area"
                                        [(ngModel)]="transition.typeUpdown" (change)="onChangeTypeUpdown(transition)" [disabled]="false" required>
                                        <option value="UPGRADE"><localize key="transition.event.type.upgrade"></localize></option>
                                        <option value="DOWNGRADE"><localize key="transition.event.type.downgrade"></localize></option>
                                    </select>
                                </td>
                                <td *ngIf="transition.typeUpdown">
                                    <input style="min-width:80px;" type="text" [name]="'transition.typePart-' + i" class="form-control" [ngModel]="localizeTransitionType(transition.typePart)" disabled required>
                                </td>
                                <td *ngIf="!readonly" style="vertical-align: middle;">
                                    <span class="clickable" (click)="remove(i)">
                                        <a class="fa fa-trash" style="font-size:30px;" aria-hidden="true"></a>
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div *ngIf="!readonly" style="margin-top: 30px; margin-bottom: 30px;" class="row">
                        <div class="col-md-6">
                            <a class="fa fa-plus" style="font-size:30px;" (click)="onCreate()"></a>
                        </div>
                    </div>

                </div>

            <div class="row-holder">
                <div class="label-holder"></div>
                <div class="holder">
                    <div class="button-holder">
                        <button type="button" (click)="onCancel()" class="btn btn-default" role="button">
                            <localize [key]="readonly ? 'io.back' : 'io.cancel'"></localize>
                        </button>
                        <button *ngIf="!readonly" type="submit" (click)="onSubmit()" class="btn btn-primary"
                            role="button" [disabled]="form.invalid">
                            <localize key="io.submit"></localize>
                        </button>
                    </div>
                </div>
            </div>

        </fieldset>
    </form>
    
    <div class="col-md-4">
      <div class="row" style="text-align: center;">
        <label class="col-md-6"><localize key="transition.event.before"></localize></label>
        <label class="col-md-6"><localize key="transition.event.after"></localize></label>
      </div>
    
      <div style="margin-top: 50px;" id="svgHolder"></div>
    </div>
</div>